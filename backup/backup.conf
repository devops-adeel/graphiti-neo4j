# Neo4j Backup Configuration for Graphiti
# Centralized configuration for all backup operations

# ============================================
# Primary Backup Locations
# ============================================
PRIMARY_BACKUP_DIR="${HOME}/Neo4jBackups"
BACKUP_DIR="${PRIMARY_BACKUP_DIR}"  # Alias for compatibility

# External backup location (auto-detected when available)
EXTERNAL_DRIVE_NAME="SanDisk"
EXTERNAL_BACKUP_DIR="/Volumes/${EXTERNAL_DRIVE_NAME}/Neo4jBackups"

# OrbStack volume location (for direct access)
ORBSTACK_VOLUME_PATH="${HOME}/OrbStack/docker/volumes/graphiti-neo4j_neo4j-data/_data"

# ============================================
# Retention Policies
# ============================================
# Daily backups (7-day retention)
BACKUP_RETENTION_DAILY=7
BACKUP_CRON_DAILY="0 2 * * *"        # Daily at 2 AM

# Weekly backups (4-week retention)
BACKUP_RETENTION_WEEKLY=28
BACKUP_CRON_WEEKLY="0 3 * * 0"       # Sundays at 3 AM

# Monthly backups (12-month retention)
BACKUP_RETENTION_MONTHLY=365
BACKUP_CRON_MONTHLY="0 4 1 * *"      # 1st of month at 4 AM

# ============================================
# Docker Configuration
# ============================================
COMPOSE_PROJECT_NAME="graphiti-neo4j"
CONTAINER_NAME="neo4j-graphiti"
BACKUP_VERSION="v2.43.0"             # offen/docker-volume-backup version

# ============================================
# Neo4j Specific Settings
# ============================================
NEO4J_DATABASE="neo4j"               # Database name
NEO4J_STOP_TIMEOUT="10m"             # Time to wait for clean shutdown
NEO4J_HEAP_THRESHOLD="85"            # Trigger backup if heap usage > 85%
NEO4J_ADMIN_DUMP=true                # Create neo4j-admin dumps for portability

# ============================================
# Backup Behavior
# ============================================
# Compression settings
BACKUP_COMPRESSION_DAILY="gz"        # Fast compression for daily
BACKUP_COMPRESSION_WEEKLY="zst"      # Better compression for weekly
BACKUP_COMPRESSION_MONTHLY="zst"     # Maximum compression for monthly
GZIP_PARALLELISM=4                   # Parallel compression threads

# External drive sync
SYNC_ON_BACKUP=true                  # Auto-sync to external when available
SYNC_CHECK_INTERVAL=30               # Seconds between external drive checks
SYNC_MAX_WAIT=300                    # Max seconds to wait for external drive
SYNC_RSYNC_OPTIONS="-av --delete"   # Rsync options for external sync

# ============================================
# Notification Settings
# ============================================
NOTIFICATION_LEVEL="error"           # Options: error, info, debug
# NOTIFICATION_WEBHOOK=""            # Optional: Webhook URL for alerts
# NOTIFICATION_EMAIL=""              # Optional: Email for critical alerts

# ============================================
# Memory Forensics Integration
# ============================================
BACKUP_HEAP_DUMPS=true               # Include heap dumps in monthly backups
BACKUP_METRICS=true                  # Include metrics in all backups
BACKUP_GC_LOGS=true                  # Include GC logs in weekly/monthly
MAX_HEAP_DUMP_SIZE="2G"              # Skip heap dumps larger than this

# ============================================
# Backup Verification
# ============================================
BACKUP_VERIFY=true                   # Verify backup integrity after creation
BACKUP_VERIFY_SAMPLE_SIZE=10         # Number of files to sample for verification
BACKUP_TEST_RESTORE=false            # Test restore monthly backups (requires extra space)
BACKUP_CHECKSUM=true                 # Generate SHA256 checksums

# ============================================
# Safety and Locking
# ============================================
BACKUP_LOCK_FILE="${PRIMARY_BACKUP_DIR}/.neo4j-backup-lock"
BACKUP_LOCK_TIMEOUT=7200             # Max backup duration in seconds (2 hours)
BACKUP_CONCURRENT=false              # Prevent concurrent backups
BACKUP_STOP_ON_ERROR=true            # Stop backup chain on error

# ============================================
# Performance Tuning
# ============================================
BACKUP_NICE_LEVEL=10                 # CPU priority (0-19, higher = lower priority)
BACKUP_IONICE_CLASS=3                # I/O priority class (3 = idle)
BACKUP_MEMORY_LIMIT="4G"             # Memory limit for backup process

# ============================================
# Advanced Options
# ============================================
BACKUP_ENCRYPT=false                 # Encrypt backups (requires GPG setup)
# BACKUP_GPG_RECIPIENT=""            # GPG key ID for encryption
BACKUP_SPLIT_SIZE=""                 # Split large backups (e.g., "4G")
BACKUP_PARALLEL=false                # Parallel volume backup (experimental)

# ============================================
# Monitoring and Metrics
# ============================================
METRICS_EXPORT_PATH="/metrics"       # Path for Prometheus metrics
METRICS_PORT=2004                    # Port for metrics endpoint (if exposed)
BACKUP_LOG_LEVEL="INFO"              # Logging verbosity

# ============================================
# Recovery Settings
# ============================================
RESTORE_VERIFY_CHECKSUMS=true        # Verify checksums before restore
RESTORE_STOP_NEO4J=true              # Stop Neo4j before restore
RESTORE_BACKUP_CURRENT=true          # Backup current data before restore
RESTORE_TEST_CONNECTION=true         # Test Neo4j connection after restore

# ============================================
# Graphiti-Specific Settings
# ============================================
GRAPHITI_EPISODE_BACKUP=true         # Backup episode boundaries
GRAPHITI_SESSION_METADATA=true       # Include session metadata
GRAPHITI_MEMORY_SNAPSHOT=true        # Create memory snapshot before backup

# ============================================
# Cleanup and Maintenance
# ============================================
CLEANUP_OLD_DUMPS=true               # Remove old neo4j-admin dumps
CLEANUP_EMPTY_BACKUPS=true           # Remove zero-size backup files
CLEANUP_ORPHANED_LOCKS=true          # Clean stale lock files
MAINTENANCE_DAY="Sunday"             # Day for maintenance tasks
MAINTENANCE_HOUR="5"                 # Hour for maintenance (5 AM)